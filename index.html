<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IRON-FLIGHT: ORBITAL DEFENSE</title>
    <style>
        body {
            margin: 0; overflow: hidden; background-color: #050510;
            font-family: 'Segoe UI', sans-serif; color: #00ffff; user-select: none;
        }
        canvas { display: block; position: absolute; top: 0; left: 0; }
        #game-layer { z-index: 1; }
        #ui-layer {
            position: absolute; z-index: 2; width: 100vw; height: 100vh;
            pointer-events: none;
            background: linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.2) 50%);
            background-size: 100% 4px;
        }
        #cam-container {
            position: absolute; bottom: 20px; right: 20px; width: 240px; height: 180px;
            border: 2px solid #555; background: #000; border-radius: 8px; z-index: 10;
        }
        #cam-container.active { border-color: #00ff00; box-shadow: 0 0 15px #00ff00; }
        #video-feed { width: 100%; height: 100%; transform: scaleX(-1); opacity: 0.6; }
        .hud-text { position: absolute; font-weight: bold; text-shadow: 0 0 10px #00ffff; }
        #score-display { top: 20px; right: 20px; font-size: 30px; }
        #health-display { top: 20px; left: 20px; font-size: 30px; color: #ff0055; }
        #center-screen {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; z-index: 20;
        }
        h1 { font-size: 50px; margin: 0; color: #fff; text-shadow: 0 0 20px #00ffff; }
        #watermark { position: absolute; bottom: 10px; left: 10px; color: #555; font-size: 12px; }
        #creator-link {
            position: absolute; top: 70px; right: 20px; padding: 5px 10px;
            border: 1px solid #00ffff; color: #00ffff; text-decoration: none;
            font-size: 12px; pointer-events: auto;
        }
        #debug-log {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            color: #ff5555; background: rgba(0,0,0,0.8); padding: 5px; display: none;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils@0.6/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <video id="input-video" playsinline style="display:none;"></video>
    <canvas id="game-layer"></canvas>

    <div id="ui-layer">
        <div id="watermark">MADE BY MD SALEH SAKIB</div>
        <a id="creator-link" href="https://linktr.ee/salehsakib" target="_blank">CONNECT</a>
        <div id="health-display">SHIELD: 100%</div>
        <div id="score-display">0</div>
        <div id="debug-log"></div>
        <div id="center-screen">
            <h1 id="main-msg">SYSTEM BOOT</h1>
            <p id="sub-msg">Loading AI...</p>
        </div>
        <div id="cam-container">
            <canvas id="video-feed"></canvas>
        </div>
    </div>

<script>
    const logError = (msg) => {
        const d = document.getElementById('debug-log');
        d.style.display = 'block'; d.innerHTML = msg; console.error(msg);
    };

    // --- SETUP ---
    const canvas = document.getElementById('game-layer');
    const ctx = canvas.getContext('2d');
    const feedCanvas = document.getElementById('video-feed');
    const feedCtx = feedCanvas.getContext('2d');
    const video = document.getElementById('input-video');
    
    let width, height;
    function resize() {
        width = window.innerWidth; height = window.innerHeight;
        canvas.width = width; canvas.height = height;
    }
    window.addEventListener('resize', resize);
    resize();
    feedCanvas.width = 320; feedCanvas.height = 240;

    // --- GAME STATE ---
    const state = { running: false, score: 0, health: 100, handSeen: false };
    const ship = { x: width/2, y: height-100, tx: width/2, ty: height-100, trails: [] };
    const obstacles = [];
    const stars = Array(100).fill().map(() => ({
        x: (Math.random()-0.5)*width*2, y: (Math.random()-0.5)*height*2, z: Math.random()*2000
    }));

    // --- MAIN LOOP ---
    function loop() {
        // 1. Clear & Background
        ctx.fillStyle = '#050510'; ctx.fillRect(0, 0, width, height);
        
        // 2. Stars
        stars.forEach(s => {
            s.z -= 10 + (state.score * 0.1);
            if(s.z <= 0) { s.z = 2000; s.x = (Math.random()-0.5)*width*2; s.y = (Math.random()-0.5)*height*2; }
            let sx = (s.x / s.z) * width + width/2;
            let sy = (s.y / s.z) * height + height/2;
            let sz = (1 - s.z/2000) * 3;
            if(sx>0 && sx<width && sy>0 && sy<height) { ctx.fillStyle='#fff'; ctx.fillRect(sx, sy, sz, sz); }
        });

        // 3. Game Logic (Wrapped in Try/Catch to prevent freeze)
        try {
            if (state.running) {
                // Move Ship
                ship.x += (ship.tx - ship.x) * 0.2;
                ship.y += (ship.ty - ship.y) * 0.2;

                // Draw Trails (SAFE MODE)
                for (let i = ship.trails.length - 1; i >= 0; i--) {
                    let t = ship.trails[i];
                    t.y += 5; t.life -= 0.1;
                    if (t.life <= 0) ship.trails.splice(i, 1);
                    else {
                        ctx.fillStyle = `rgba(0,255,255,${t.life})`;
                        ctx.beginPath();
                        // CRITICAL FIX: Math.max(0, ...) prevents negative radius crash
                        ctx.arc(t.x, t.y, Math.max(0, 5 * t.life), 0, Math.PI*2);
                        ctx.fill();
                    }
                }
                ship.trails.push({x: ship.x, y: ship.y+30, life: 1});

                // Draw Ship
                ctx.save(); ctx.translate(ship.x, ship.y);
                ctx.shadowColor='#00ffff'; ctx.shadowBlur=15;
                ctx.fillStyle='#000'; ctx.strokeStyle='#00ffff'; ctx.lineWidth=2;
                ctx.beginPath(); ctx.moveTo(0,-40); ctx.lineTo(20,20); ctx.lineTo(0,10); ctx.lineTo(-20,20); ctx.closePath();
                ctx.fill(); ctx.stroke();
                ctx.restore();

                // Obstacles
                if (Math.random() < 0.05) obstacles.push({x: Math.random()*width, y: -50, s: 30+Math.random()*30});
                
                for (let i = obstacles.length - 1; i >= 0; i--) {
                    let o = obstacles[i];
                    o.y += 5 + (state.score*0.01);
                    
                    // Draw Hexagon
                    ctx.save(); ctx.translate(o.x, o.y);
                    ctx.strokeStyle='#ff0055'; ctx.lineWidth=3; ctx.shadowColor='#ff0055'; ctx.shadowBlur=10;
                    ctx.beginPath();
                    for(let j=0; j<6; j++) ctx.lineTo(o.s*Math.cos(j*Math.PI/3), o.s*Math.sin(j*Math.PI/3));
                    ctx.closePath(); ctx.stroke(); ctx.restore();

                    // Collision
                    if (Math.hypot(ship.x-o.x, ship.y-o.y) < o.s+20) {
                        state.health -= 34;
                        obstacles.splice(i, 1);
                        document.getElementById('health-display').innerText = `SHIELD: ${Math.floor(state.health)}%`;
                        if (state.health <= 0) resetGame();
                    } else if (o.y > height+100) {
                        obstacles.splice(i, 1);
                        state.score += 10;
                        document.getElementById('score-display').innerText = state.score;
                    }
                }
            } else {
                // Idle Mode
                ctx.globalAlpha = 0.3;
                ctx.fillStyle='#00ffff'; ctx.beginPath(); ctx.arc(width/2, height-100, 20, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1;
            }
        } catch (e) {
            console.error("Game Logic Error (Skipped Frame):", e);
        }

        requestAnimationFrame(loop);
    }

    function resetGame() {
        state.running = false;
        state.health = 100;
        state.score = 0;
        obstacles.length = 0;
        document.getElementById('main-msg').innerText = "CRITICAL FAILURE";
        document.getElementById('sub-msg').innerText = "Show Hand to Reboot";
        document.getElementById('center-screen').style.display = 'block';
    }

    loop();

    // --- AI MANUAL LOOP ---
    async function initAI() {
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        
        hands.onResults(results => {
            // Draw debug feed
            feedCtx.clearRect(0, 0, 320, 240);
            feedCtx.drawImage(results.image, 0, 0, 320, 240);
            
            if (results.multiHandLandmarks.length > 0) {
                // Hand Found
                document.getElementById('cam-container').classList.add('active');
                const lm = results.multiHandLandmarks[0];
                drawConnectors(feedCtx, lm, HAND_CONNECTIONS, {color: '#00ff00', lineWidth: 2});
                
                // Update Ship Target
                ship.tx = (1 - lm[8].x) * width;
                ship.ty = lm[8].y * height;

                // Start Game Trigger
                if (!state.running && document.getElementById('main-msg').innerText !== "SYSTEM BOOT") {
                    state.running = true;
                    document.getElementById('center-screen').style.display = 'none';
                    document.getElementById('health-display').innerText = "SHIELD: 100%";
                } else if (!state.running) {
                    document.getElementById('main-msg').innerText = "READY";
                    document.getElementById('sub-msg').innerText = "Hold Steady...";
                }
            } else {
                document.getElementById('cam-container').classList.remove('active');
                if(state.running) {
                    state.running = false;
                    document.getElementById('main-msg').innerText = "SIGNAL LOST";
                    document.getElementById('sub-msg').innerText = "Show Hand to Resume";
                    document.getElementById('center-screen').style.display = 'block';
                }
            }
        });

        // Setup Camera
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 } });
            video.srcObject = stream;
            await video.play();
            document.getElementById('sub-msg').innerText = "Show Hand to Start";
            
            // Manual processing loop (More robust than CameraUtils)
            async function aiLoop() {
                await hands.send({image: video});
                requestAnimationFrame(aiLoop);
            }
            aiLoop();

        } catch (e) {
            logError("Camera Error: " + e.message);
        }
    }

    initAI();

</script>
</body>
</html>
