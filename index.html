<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IRON-FLIGHT: ORBITAL DEFENSE</title>
    <style>
        /* SCI-FI STYLING */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050510;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #00ffff;
            user-select: none; /* Prevent text selection while playing */
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        #game-layer { z-index: 1; }
        
        /* HUD LAYER */
        #ui-layer {
            position: absolute;
            z-index: 2;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
        }

        /* DEBUG CAM */
        #cam-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 240px;
            height: 180px;
            border: 2px solid #00ffff;
            background: rgba(0, 20, 20, 0.8);
            border-radius: 8px;
            box-shadow: 0 0 15px #00ffff;
            overflow: hidden;
            z-index: 10;
        }
        
        #video-feed {
            width: 100%;
            height: 100%;
            transform: scaleX(-1); /* Mirror effect */
            opacity: 0.6;
        }

        /* TEXT ELEMENTS */
        .hud-text {
            position: absolute;
            font-weight: bold;
            text-shadow: 0 0 10px #00ffff;
            letter-spacing: 2px;
        }

        #score-display { top: 20px; right: 180px; font-size: 30px; } /* Moved left to make room for button */
        #health-display { top: 20px; left: 40px; font-size: 30px; color: #ff0055; text-shadow: 0 0 10px #ff0055; }
        
        #center-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 20;
        }

        h1 { font-size: 60px; margin: 0; text-transform: uppercase; color: #fff; text-shadow: 0 0 20px #00ffff; }
        p { font-size: 18px; color: #aaa; background: rgba(0,0,0,0.7); padding: 10px; }

        /* WATERMARK & LINK BUTTON */
        #watermark {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            z-index: 100;
            pointer-events: auto; /* Allow clicking if needed */
        }

        #creator-link {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid #00ffff;
            color: #00ffff;
            text-decoration: none;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            pointer-events: auto; /* Crucial for clickability */
            z-index: 100;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }

        #creator-link:hover {
            background: #00ffff;
            color: #000;
            box-shadow: 0 0 15px #00ffff;
        }

        /* SCANLINE ANIMATION */
        .scanline {
            width: 100%;
            height: 100px;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(0, 255, 255, 0.2) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scanline 10s linear infinite;
            pointer-events: none;
        }

        @keyframes scanline {
            0% { bottom: 100%; }
            100% { bottom: -100px; }
        }

    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <video id="input-video" style="display: none;"></video>

    <canvas id="game-layer"></canvas>

    <div id="ui-layer">
        <div class="scanline"></div>
        
        <div id="watermark">MADE BY MD SALEH SAKIB</div>
        <a id="creator-link" href="https://linktr.ee/salehsakib" target="_blank">CONNECT</a>

        <div id="health-display" class="hud-text">SHIELD: 100%</div>
        <div id="score-display" class="hud-text">SCORE: 0</div>
        
        <div id="center-screen">
            <h1 id="main-msg">SYSTEM BOOT</h1>
            <p id="sub-msg">Initializing Neural Link...<br>Please Allow Camera Access.</p>
        </div>

        <div id="cam-container">
            <canvas id="video-feed"></canvas>
            <div style="position:absolute; bottom:5px; left:5px; font-size:10px; color:#00ffff;">RAW FEED</div>
        </div>
    </div>

<script>
    /** * CONFIGURATION 
     */
    const config = {
        speed: 5,
        starCount: 200,
        colors: {
            ship: '#00ffff',
            enemy: '#ff0055',
            bg: '#050510'
        }
    };

    /**
     * STATE
     */
    const state = {
        gameRunning: false,
        score: 0,
        health: 100,
        frame: 0,
        handDetected: false
    };

    /**
     * SETUP CANVAS
     */
    const canvas = document.getElementById('game-layer');
    const ctx = canvas.getContext('2d');
    
    const feedCanvas = document.getElementById('video-feed');
    const feedCtx = feedCanvas.getContext('2d');

    let width, height;

    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
    }
    window.addEventListener('resize', resize);
    resize();
    
    // Feed canvas fixed size
    feedCanvas.width = 240;
    feedCanvas.height = 180;

    /**
     * GAME OBJECTS
     */
    
    // The Player Ship
    const ship = {
        x: width / 2,
        y: height - 150,
        targetX: width / 2,
        targetY: height - 150,
        width: 40,
        height: 60,
        trails: [],
        
        draw: function() {
            // Smooth movement (Linear Interpolation)
            this.x += (this.targetX - this.x) * 0.15;
            this.y += (this.targetY - this.y) * 0.15;

            // Draw Engine Trails
            this.trails.push({x: this.x, y: this.y + 30, life: 1});
            this.trails.forEach((t, i) => {
                t.y += 5;
                t.life -= 0.1;
                if(t.life <= 0) this.trails.splice(i, 1);
                
                ctx.fillStyle = `rgba(0, 255, 255, ${t.life})`;
                ctx.beginPath();
                ctx.arc(t.x, t.y, 5 * t.life, 0, Math.PI*2);
                ctx.fill();
            });

            // Draw Ship Body (Sci-Fi Shape)
            ctx.save();
            ctx.translate(this.x, this.y);
            
            // Glow
            ctx.shadowColor = config.colors.ship;
            ctx.shadowBlur = 20;

            ctx.fillStyle = "#000";
            ctx.strokeStyle = config.colors.ship;
            ctx.lineWidth = 2;

            ctx.beginPath();
            ctx.moveTo(0, -40);
            ctx.lineTo(20, 20);
            ctx.lineTo(10, 30);
            ctx.lineTo(-10, 30);
            ctx.lineTo(-20, 20);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // Inner details
            ctx.fillStyle = config.colors.ship;
            ctx.beginPath();
            ctx.arc(0, 0, 5, 0, Math.PI*2);
            ctx.fill();

            ctx.restore();
        }
    };

    // Stars
    let stars = [];
    class Star {
        constructor() {
            this.reset();
        }
        reset() {
            this.x = (Math.random() - 0.5) * width * 2; // Spread wider
            this.y = (Math.random() - 0.5) * height * 2;
            this.z = Math.random() * 2000; // Depth
        }
        update() {
            this.z -= 10 + (state.score * 0.1); // Speed up as score increases
            if (this.z <= 0) this.reset();
        }
        draw() {
            // Perspective Projection
            let sx = (this.x / this.z) * width + width/2;
            let sy = (this.y / this.z) * height + height/2;
            let size = (1 - this.z / 2000) * 4;

            if (sx > 0 && sx < width && sy > 0 && sy < height) {
                ctx.fillStyle = "#fff";
                ctx.globalAlpha = 1 - this.z / 2000;
                ctx.fillRect(sx, sy, size, size);
                ctx.globalAlpha = 1;
            }
        }
    }
    // Init stars
    for(let i=0; i<config.starCount; i++) stars.push(new Star());

    // Obstacles
    let obstacles = [];
    class Obstacle {
        constructor() {
            this.x = Math.random() * width;
            this.y = -100;
            this.size = 30 + Math.random() * 50;
            this.speed = 4 + Math.random() * 4 + (state.score * 0.05);
            this.angle = 0;
            this.spin = (Math.random() - 0.5) * 0.1;
        }
        update() {
            this.y += this.speed;
            this.angle += this.spin;
        }
        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.angle);
            
            ctx.strokeStyle = config.colors.enemy;
            ctx.lineWidth = 3;
            ctx.shadowColor = config.colors.enemy;
            ctx.shadowBlur = 10;
            
            // Draw Hexagon
            ctx.beginPath();
            for (let i = 0; i < 6; i++) {
                ctx.lineTo(this.size * Math.cos(i * Math.PI / 3), this.size * Math.sin(i * Math.PI / 3));
            }
            ctx.closePath();
            ctx.stroke();

            // Core
            ctx.fillStyle = 'rgba(255, 0, 85, 0.2)';
            ctx.fill();

            ctx.restore();
        }
    }

    /**
     * GAME LOOP
     */
    function updateMsg(title, sub) {
        document.getElementById('main-msg').innerText = title;
        document.getElementById('sub-msg').innerHTML = sub;
        document.getElementById('center-screen').style.display = 'block';
    }

    function gameLoop() {
        // Clear Background
        ctx.fillStyle = config.colors.bg;
        ctx.fillRect(0, 0, width, height);

        // 1. Draw Grid Floor (Retro Vibe)
        ctx.strokeStyle = "rgba(0, 255, 255, 0.1)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        // Vertical lines moving outward
        for(let i=-width; i<width*2; i+=100) {
            // Simple perspective hack
            ctx.moveTo(width/2 + (i - width/2) * 0.2, 0);
            ctx.lineTo(i, height);
        }
        ctx.stroke();

        // 2. Stars
        stars.forEach(s => { s.update(); s.draw(); });

        // 3. Game Logic
        if (state.gameRunning) {
            ship.draw();
            
            // Spawn Obstacles
            if (state.frame % 40 === 0) obstacles.push(new Obstacle());

            // Handle Obstacles
            obstacles.forEach((obs, index) => {
                obs.update();
                obs.draw();

                // Collision
                const dx = ship.x - obs.x;
                const dy = ship.y - obs.y;
                const dist = Math.sqrt(dx*dx + dy*dy);

                if (dist < obs.size + 20) {
                    // Hit!
                    state.health -= 34; // 3 hits = dead
                    obstacles.splice(index, 1);
                    document.getElementById('health-display').innerText = `SHIELD: ${Math.floor(state.health)}%`;
                    
                    // Screen shake effect
                    canvas.style.transform = `translate(${Math.random()*20-10}px, ${Math.random()*20-10}px)`;
                    setTimeout(() => canvas.style.transform = "none", 100);

                    if (state.health <= 0) {
                        gameOver();
                    }
                }

                // Score
                if (obs.y > height + 100) {
                    obstacles.splice(index, 1);
                    state.score += 100;
                    document.getElementById('score-display').innerText = `SCORE: ${state.score}`;
                }
            });

            state.frame++;
        } else {
            // Idle Animation (Ghost Ship)
            ctx.globalAlpha = 0.3;
            ship.draw();
            ctx.globalAlpha = 1;
        }

        requestAnimationFrame(gameLoop);
    }
    
    function gameOver() {
        state.gameRunning = false;
        updateMsg("CRITICAL FAILURE", `Score: ${state.score}<br>Show Hand to Reboot System`);
        state.health = 100;
        state.score = 0;
        obstacles = [];
    }

    function startGame() {
        if (!state.gameRunning) {
            state.gameRunning = true;
            document.getElementById('center-screen').style.display = 'none';
            document.getElementById('health-display').innerText = "SHIELD: 100%";
        }
    }

    gameLoop(); // Start render loop immediately

    /**
     * MEDIA PIPE (AI HAND TRACKING)
     */
    const videoElement = document.getElementById('input-video');

    function onResults(results) {
        // Draw the small debug feed
        feedCtx.clearRect(0, 0, feedCanvas.width, feedCanvas.height);
        feedCtx.drawImage(results.image, 0, 0, feedCanvas.width, feedCanvas.height);

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            
            // Hand Found
            if (document.getElementById('main-msg').innerText === "SYSTEM BOOT") {
                updateMsg("READY", "Hold steady to start");
            }

            const landmarks = results.multiHandLandmarks[0];
            drawConnectors(feedCtx, landmarks, HAND_CONNECTIONS, {color: '#00ffff', lineWidth: 2});

            // Get Index Finger Tip (Landmark 8)
            const tip = landmarks[8];
            
            // Calculate screen coordinates (Mirrored X)
            const x = (1 - tip.x) * width;
            const y = tip.y * height;

            // Update Ship Target
            ship.targetX = x;
            ship.targetY = y;

            if (!state.gameRunning && document.getElementById('main-msg').innerText !== "SYSTEM BOOT") {
                startGame();
            }
        } else {
            // Hand Lost
            if (state.gameRunning) {
                state.gameRunning = false;
                updateMsg("SIGNAL LOST", "Re-align Neural Link (Show Hand)");
            }
        }
    }

    const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    hands.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => {
            await hands.send({image: videoElement});
        },
        width: 640,
        height: 480
    });

    // START CAMERA
    updateMsg("SYSTEM BOOT", "Loading AI Models...");
    camera.start()
        .then(() => updateMsg("WAITING FOR PILOT", "Please show your hand"))
        .catch(err => updateMsg("ERROR", "Camera access denied or file:// protocol restriction.<br>Please use a Local Server."));

</script>
</body>
</html>
